var transporter = require('../config/email');
var Sujet = require('../models/sujet')
var Student = require('../models/student')
var Soutenance = require('../models/soutenance')
var User = require('../models/user')

module.exports = {

    envoyerEmail:(idSujet)=>{

        Sujet.findOne({_id:idSujet} ,(err, sjt) => {
            if (err)
                res.send(err);
            var sujet = sjt;
            Student.findOne({_id: sujet.student_id} ,(err, stdnt) => {
                if (err)
                    res.send(err);
                var student = stdnt
                console.log(student)
                User.findOne( {_id: student.user_id}  ,(err, usr) => {
                    if (err)
                          res.send(err);
                    var user = usr
                    Soutenance.findOne( {sujet_id: sujet._id}  ,(err, stn) => {
                        if (err)
                              res.send(err);
                        var soutenance = stn
                        User.findOne({_id: sujet.professor_id }, (err, prof)=>{
                            if (err)
                                res.send(err);
                            var professor = prof
                                 
                            output =  `<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> <html xmlns="http://www.w3.org/1999/xhtml"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"> <!-- General CSS --> <style type="text/css"> html{ width: 100%; } body{ font-family: calibri light ; width: 100%; margin:0; padding:0; -webkit-font-smoothing: antialiased; mso-margin-top-alt:0px; mso-margin-bottom-alt:0px; mso-padding-alt: 0px 0px 0px 0px; background: #E7E7E7; } p,h1,h2,h3,h4{ margin-top:0; margin-bottom:0; padding-top:0; padding-bottom:0; } table{ font-size: 16px; border: 0; } img{ border: none!important; } button{ background:#3498db; color:#fff; border-radius: 4px; border:none; position:relative; height:60px; font-size:1.6em; padding:0 2em; cursor:pointer; transition:800ms ease all; outline:none; } button:hover{ background:#fff; color:#3498db; } button:before,button:after{content: '';position:absolute; top:0; right:0; height:2px; width:0; background: #3498db; transition:400ms ease all; } button:after{ right:inherit; top:inherit; left:0; bottom:0; } button:hover:before,button:hover:after{ width:100%; transition:800ms ease all; } </style> <!-- Responsive CSS --> <style type="text/css"> @media only screen and (max-width: 800px) { body[yahoo] .quote_full_width {width:100% !important;} body[yahoo] .quote_content_width {width:90% !important;} } @media only screen and (max-width: 640px) { body[yahoo] .full_width {width:100% !important;} body[yahoo] .content_width{width:80% !important;} body[yahoo] .center_txt {text-align: center!important;} body[yahoo] .post_sep {width:100% !important; height:60px !important;} body[yahoo] .gal_sep {width:100% !important; height:40px !important;} body[yahoo] .gal_img {width:100% !important;} body[yahoo] .bb_space {height:90px !important;} } </style> </head> <body style="margin: 0; padding: 0;" yahoo="fix"> <!-- billboard --> <table border="0" cellpadding="0" cellspacing="0" width="100%" background="https://s31.postimg.cc/8nuftcyq3/Untitl.jpg" bgcolor="#2a3647" style="background-size: cover; -webkit-background-size: cover; -moz-background-size: cover -o-background-size: cover; background-position: bottom center; background-repeat: no-repeat; background-color:#2a3647;"> <!-- header --> <tr> <td> <table width="600" cellpadding="0" cellspacing="0" align="center" border="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; border:0; text-align:center;" class="content_width"> <!-- spacing --> <tr> <td width="100%" height="0">&nbsp;</td> </tr> <!-- end spacing --> <!-- Logo --> <tr> <td> <img src="https://image.ibb.co/jaVp4H/ensa_logo.png" width="300" height="300" alt="" title="" border="0" style="border:0; display:inline_block;"/> </td> </tr> <!-- end logo --> <!-- spacing --> <tr> <td width="100%" height="0">&nbsp;</td> </tr> <!-- end spacing --> <!-- vertical separator --> <tr> <td> <table width="600" height="5" align="center" bgcolor="#343f53" border="0" cellpadding="0" cellspacing="0"style="height:2px!important; width:600px; background-color:#ffffff; padding:0; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <tr> <td></td> </tr> </table> </td> </tr> <!-- end vertical separator --> </table> </td> </tr> <!-- end header --> <!-- end spacing --> <!-- caption --> <tr> <td> <table width="600" cellpadding="0" cellspacing="0" align="center" class="content_width" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <tr> <td> <table cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="content_width" align="center"> <tr> <td style="color: #fff; font-size: 28px; font-weight: 700; text-transform: uppercase; line-height:50px; letter-spacing:1px;"><br>Sujet : ${ sujet.titre } <span style="color:#00ff00;">accord√©e</span></td> </tr> </table> </td> </tr> </table> </td> </tr> <!-- end caption --> <!-- spacing --> <tr> <td height="0">&nbsp;</td> </tr> <!-- end spacing --> <!-- download btn --> <tr> <td> <table width="290" cellpadding="0" cellspacing="0" align="center" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="content_width"> <tr> <td> <table width="" cellpadding="0" cellspacing="0" align="center" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="center"> <tr> <td> <br> <button style="text-transform: uppercase; letter-spacing: 1px; font-size:26px; font-weight:500; font-family:calibri; " >plus</button><br> </td> </tr> </table> </td> </tr> </table> </td> </tr> <!-- spacing --> <tr> <td height="20">&nbsp;</td> </tr> <!-- end download btn --> </table><!-- end billboard --> <!-- features section --> <table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#fbfbfb" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <!-- spacing --> <tr> <td width="100%" height="50">&nbsp;</td> </tr> <!-- end spacing --> <tr> <td> <table width="600" align="center" border="0" cellpadding="0" cellspacing="0" style="text-align:center;" class="content_width"> <!-- section title --> <tr> <td style="color: #414d5f; font-size: 22px; font-weight: 700; letter-spacing:.5px; text-transform:uppercase;">Informations</td> </tr> <!-- end section title --> <!-- spacing --> <tr> <td width="100%" height="20">&nbsp;</td> </tr> <!-- end spacing --> <!-- vertical separator --> <tr> <td> <table width="1" height="20" align="center" bgcolor="#e9e9e9" border="0" cellpadding="0" cellspacing="0"style="height:20px!important; padding:0; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <tr> <td></td> </tr> </table> </td> </tr> <!-- end vertical separator --> <!-- horizontal separator --> <tr> <td> <table width="100%" height="1" align="center" bgcolor="#e9e9e9" border="0" cellpadding="0" cellspacing="0"style="padding:0;border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <tr> <td></td> </tr> </table> </td> </tr> <!-- end horizontal separator --> <!-- spacing --> <tr> <td width="100%" height="40">&nbsp;</td> </tr> <!-- end spacing --> <!-- features --> <tr> <td> <table width="394" cellpadding="0" align="left" cellspacing="0"style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width"> <tr> <td> <!-- feature 1 --> <table width="187" cellpadding="0" align="left" cellspacing="0"style="text-align:center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width"> <tr> <td> <img src="https://image.ibb.co/niOyyc/icon_1.png" width="100" height="100" alt="" title="" align="center" border="0" style="display: inline-block; border:0;"/> </td> </tr> <tr> <td width="100%" height="20"></td> </tr><tr> <td style="color: #495d79; font-size: 18px; font-weight: 700; text-transform: uppercase;">Encadrant</td> </tr> <tr> <td width="100%" height="40"></td> </tr> <tr> <td> <p style="color: #7187a7; font-size: 16px; line-height:24px; letter-spacing:.5px; font-weight: 400;">${ professor.nom +' '+ professor.prenom } </p> <p style="color: #7187a7; font-size: 16px; line-height:24px; letter-spacing:.5px; font-weight: 400;">${ professor.email }</p> </td> </tr> </table> <!-- end feature 1 --> <!-- spacing --> <table height="40" align="left" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="post_sep"> <tr> <td>&nbsp;</td> </tr> </table> <!-- feature 2 --> <table width="187" cellpadding="0" align="right" cellspacing="0"style="text-align:center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width"> <tr> <td> <img src="https://image.ibb.co/dsW7rx/icon_2.png" width="100" height="100" alt="" title="" align="center" border="0" style="display: inline-block; border:0;"/> </td> </tr><tr> <td width="100%" height="20"></td> </tr> <tr> <td style="color: #495d79; font-size: 18px; font-weight: 700; text-transform: uppercase;">Date</td> </tr> <tr> <td width="100%" height="40"></td> </tr> <tr> <td> <p style="color: #7187a7;font-size: 16px; line-height:24px; letter-spacing:.5px; font-weight: 400;">${ soutenance.date }</p> </td> </tr> </table> <!-- end feature 2 --> </td> </tr> </table> <!-- spacing --> <table height="40" align="left" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="post_sep"> <tr> <td>&nbsp;</td> </tr> </table> <!-- end spacing --> <!-- feature 3 --> <table width="187" align="right" cellpadding="0" cellspacing="0"style="text-align:center; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width"> <tr> <td> <img src="https://image.ibb.co/ntQp4H/icon_3.png" width="100" height="100" alt="" title="" align="center" border="0" style="display: inline-block; border:0;"/> </td> </tr> <tr> <td width="100%" height="20"></td> </tr> <tr> <td style="color: #495d79; font-size: 18px; font-weight: 700; text-transform: uppercase;">Jur√©e</td> </tr> <tr> <td width="100%" height="40"></td> </tr> <tr> <td> `
                            tab = soutenance.jury.split(',')
                            tab.forEach(element => {

                                output += `<p style="color: #7187a7;font-size: 16px; line-height:24px; letter-spacing:.5px; font-weight: 400;">${element} </p>`
                                
                            });

                                    output += ` </td> </tr> </table> <!-- end feature 3 --> </td> </tr> <!-- end features --> </table> </td> </tr> <tr> <td width="100%" height="100"></td> </tr> </table><!-- end features section --> <!-- footer --> <table width="100%" border="0" cellpadding="0" cellspacing="0" bgcolor="#f5f5f5" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <tr> <td> <!-- footer top block --> <table width="600" align="center" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; border:0px;" class="content_width"> <!-- spacing --> <tr> <td width="100%" height="40">&nbsp;</td> </tr> <!-- end spacing --> <!-- content --> <tr> <td> <!-- footer logo --> <table align="left" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width center_txt"> <tr> <td> <a href="http://ensate.uae.ac.ma" style="text-decoration:none;color: #414d60; " >ENSA Tetouane</a> </td> </tr> </table> <!-- end logo --> <!-- spacing --> <table height="40" align="left" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width"> <tr> <td>&nbsp;</td> </tr> </table> <!-- end spacing --> <!-- footer links --> <table align="right" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width center_txt"> <tr> <td style="color: #414d5f; font-size: 16px; letter-spacing:0.5px; font-weight: 400;"> <a href="#" style="color: #414d60; text-decoration:none;">Contact</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </td> </tr> </table> <!-- end footer links --> </td> </tr> <!-- content --> <!-- spacing --> <tr> <td width="100%" height="40">&nbsp;</td> </tr> <!-- end spacing --> <!-- vertical separator --> <tr> <td> <table width="600" height="1" align="center" bgcolor="#e5e5e5" border="0" cellpadding="0" cellspacing="0"style="height:1px!important; width:600px; background-color:#e5e5e5; padding:0; border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;"> <tr> <td></td> </tr> </table> </td> </tr> <!-- end vertical separator --> </table> <!-- end footer top block --> <!-- footer bottom block --> <table width="600" align="center" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="content_width"> <tr> <td width="100%" height="40"></td> </tr> <!-- end spacing --> <!-- content --> <tr> <td> <!-- copyrights --> <table align="left" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width center_txt"> <tr> <td style="color: #414d5f; font-size: 14px; letter-spacing:.5px; font-weight: 400;"> ¬© 2018 <a href="http://ensate.uae.ac.ma" target="_blank" style="color: #414d5f; font-weight: 600; text-decoration:none;">ENSATE</a>. All Rights Reserved </td> </tr> </table> <!-- end copyrights --> <!-- spacing --> <table height="40" align="left" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width"> <tr> <td>&nbsp;</td> </tr> </table> <!-- end spacing --> <!-- social media --> <table align="right" border="0" cellpadding="0" cellspacing="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;" class="full_width center_txt"> <tr> <td> <a href="#" target="_blank" style="color: #414d60; text-decoration:none;"><img src="https://image.ibb.co/b6QNPH/facebook.png" width="7" height="12" alt="" title="" border="0" style="border:0; display:inline_block;"/></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="#" target="_blank" style="color: #414d60; text-decoration:none;"><img src="https://image.ibb.co/j7pSrx/twitter.png" width="14" height="10" alt="" title="" border="0" style="border:0; display:inline_block;"/></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="#" target="_blank" style="color: #414d60; text-decoration:none;"><img src="https://image.ibb.co/hpdnrx/gplus.png" width="6" height="12" alt="" title="" border="0" style="border:0; display:inline_block;"/></a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="#" target="_blank" style="color: #414d60; text-decoration:none;"><img src="https://image.ibb.co/e58bjH/linkedin.png" width="11" height="12" alt="" title="" border="0" style="border:0; display:inline_block;"/></a> </td> </tr> </table> <!-- end social media --> </td> </tr> <!-- end content --> <!-- spacing --> <tr> <td width="100%" height="40">&nbsp;</td> </tr> <!-- end spacing --> </table> <!-- end footer bottom block --> </td> </tr> </table> <!-- end footer --> </body> </html>`;


                                    var mailOptions = {
                                        from: 'ay.chakri@gmail.com',
                                        to: user.email,
                                        subject: 'Gestion Des PFE - ENSA TETOUAN - Attribution de sujet',
                                        html: output
                                    };

                                    transporter.sendMail(mailOptions, function(error, info){
                                        if (error) {
                                            console.log(error);
                                        } else {
                                            console.log('Email sent: ' + info.response);
                                        }
                                    });

                        })
                    });
                });
            });
        });
   
    }
}